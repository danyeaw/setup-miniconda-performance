name: Channel Performance Analysis

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: [ '.github/workflows/channel-performance.yml' ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  full-channels:
    name: Full Channels Test
    runs-on: windows-latest
    timeout-minutes: 30
    outputs:
      total-time: ${{ steps.results.outputs.total-time }}
      packages-found: ${{ steps.results.outputs.packages-found }}
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Timing
        run: |
          echo "TOTAL_START_TIME=$([System.DateTime]::Now.Ticks)" >> $env:GITHUB_ENV

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniconda-version: "latest"
          channels: conda-forge,defaults
          auto-activate-base: false

      - name: Create Environment
        run: |
          conda env create -f environment.yml -n test-env

      - name: Count Packages
        run: |
          $package_count = 0
          try {
            $search_result = conda search 2>&1
            if ($LASTEXITCODE -eq 0) {
              $package_count = ($search_result | Where-Object { $_ -match "^\w+\s+" } | Measure-Object).Count
            }
          } catch {
            $package_count = 0
          }
          echo "PACKAGES_FOUND=$package_count" >> $env:GITHUB_ENV

      - name: Calculate Results
        id: results
        run: |
          $end_time = [System.DateTime]::Now.Ticks
          $duration = ($end_time - $env:TOTAL_START_TIME) / 10000000
          $formatted_duration = [math]::Round($duration, 1)
          
          echo "Full channels: ${formatted_duration}s, ${env:PACKAGES_FOUND} packages"
          echo "total-time=$formatted_duration" >> $env:GITHUB_OUTPUT
          echo "packages-found=${env:PACKAGES_FOUND}" >> $env:GITHUB_OUTPUT

      - name: Cleanup
        if: always()
        run: conda env remove -n test-env -y

  defaults-only:
    name: Defaults Only Test
    runs-on: windows-latest
    timeout-minutes: 30
    outputs:
      total-time: ${{ steps.results.outputs.total-time }}
      packages-found: ${{ steps.results.outputs.packages-found }}
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Timing
        run: |
          echo "TOTAL_START_TIME=$([System.DateTime]::Now.Ticks)" >> $env:GITHUB_ENV

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniconda-version: "latest"
          channels: defaults
          auto-activate-base: false

      - name: Create Environment
        run: |
          conda env create -f environment-defaults.yml -n test-env

      - name: Count Packages
        run: |
          $package_count = 0
          try {
            $search_result = conda search -c defaults --override-channels 2>&1
            if ($LASTEXITCODE -eq 0) {
              $package_count = ($search_result | Where-Object { $_ -match "^\w+\s+" } | Measure-Object).Count
            }
          } catch {
            $package_count = 0
          }
          echo "PACKAGES_FOUND=$package_count" >> $env:GITHUB_ENV

      - name: Calculate Results
        id: results
        run: |
          $end_time = [System.DateTime]::Now.Ticks
          $duration = ($end_time - $env:TOTAL_START_TIME) / 10000000
          $formatted_duration = [math]::Round($duration, 1)
          
          echo "Defaults only: ${formatted_duration}s, ${env:PACKAGES_FOUND} packages"
          echo "total-time=$formatted_duration" >> $env:GITHUB_OUTPUT
          echo "packages-found=${env:PACKAGES_FOUND}" >> $env:GITHUB_OUTPUT

      - name: Cleanup
        if: always()
        run: conda env remove -n test-env -y

  custom-channel:
    name: Custom Channel Test
    runs-on: windows-latest
    timeout-minutes: 30
    outputs:
      total-time: ${{ steps.results.outputs.total-time }}
      packages-found: ${{ steps.results.outputs.packages-found }}
      success: ${{ steps.results.outputs.success }}
    defaults:
      run:
        shell: pwsh
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start Timing
        run: |
          echo "TOTAL_START_TIME=$([System.DateTime]::Now.Ticks)" >> $env:GITHUB_ENV

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniconda-version: "latest"
          auto-activate-base: false

      - name: Configure Custom Channel Only
        run: |
          echo "Configuring strict custom channel mode..."
          conda config --remove-key channels 2>$null || echo "No channels to remove"
          conda config --add channels danyeaw/label/danyeaw
          conda config --set channel_priority strict
          conda config --set restore_free_channel false
          echo "Final channel config:"
          conda config --show channels

      - name: Clean Environment
        run: |
          conda clean --all -y
          $packagesToRemove = @('requests', 'pytest', 'numpy', 'pandas', 'certifi', 'charset-normalizer', 'idna', 'urllib3')
          
          foreach ($pkg in $packagesToRemove) {
            try {
              python -m pip uninstall $pkg -y
              Write-Host "Removed: $pkg"
            } catch {
              Write-Host "Package $pkg not found or already removed"
            }
          }

      - name: Create Environment
        id: env-create
        run: |
          conda env create -f environment-small-channel.yml -n test-env

      - name: Count Packages
        run: |
          $package_count = 0
          try {
            $search_result = conda search -c danyeaw/label/danyeaw --override-channels 2>&1
            if ($LASTEXITCODE -eq 0) {
              $package_count = ($search_result | Where-Object { $_ -match "^\w+\s+" } | Measure-Object).Count
            }
          } catch {
            $package_count = 0
          }
          echo "PACKAGES_FOUND=$package_count" >> $env:GITHUB_ENV

      - name: Calculate Results
        id: results
        run: |
          $end_time = [System.DateTime]::Now.Ticks
          $duration = ($end_time - $env:TOTAL_START_TIME) / 10000000
          $formatted_duration = [math]::Round($duration, 1)
          $success = if ('${{ steps.env-create.outcome }}' -eq 'success') { 'true' } else { 'false' }
          
          echo "Custom channel: ${formatted_duration}s, ${env:PACKAGES_FOUND} packages, Success: $success"
          echo "total-time=$formatted_duration" >> $env:GITHUB_OUTPUT
          echo "packages-found=${env:PACKAGES_FOUND}" >> $env:GITHUB_OUTPUT
          echo "success=$success" >> $env:GITHUB_OUTPUT

      - name: Cleanup
        if: always()
        run: conda env remove -n test-env -y

  results:
    name: Compare Results
    runs-on: windows-latest
    needs: [full-channels, defaults-only, custom-channel]
    if: always()
    steps:
      - name: Generate Report
        shell: pwsh
        run: |
          echo "# Channel Performance Results" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "| Channel | Time (s) | Packages | Status |" >> $env:GITHUB_STEP_SUMMARY
          echo "|---------|----------|----------|--------|" >> $env:GITHUB_STEP_SUMMARY
          echo "| Full Channels | ${{ needs.full-channels.outputs.total-time }} | ${{ needs.full-channels.outputs.packages-found }} | ✅ Success |" >> $env:GITHUB_STEP_SUMMARY
          echo "| Defaults Only | ${{ needs.defaults-only.outputs.total-time }} | ${{ needs.defaults-only.outputs.packages-found }} | ✅ Success |" >> $env:GITHUB_STEP_SUMMARY
          
          $custom_status = if ('${{ needs.custom-channel.outputs.success }}' -eq 'true') { "✅ Success" } else { "❌ Failed" }
          echo "| Custom Channel | ${{ needs.custom-channel.outputs.total-time }} | ${{ needs.custom-channel.outputs.packages-found }} | $custom_status |" >> $env:GITHUB_STEP_SUMMARY
          
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "## Analysis" >> $env:GITHUB_STEP_SUMMARY
          
          $full_time = [double]'${{ needs.full-channels.outputs.total-time }}'
          $defaults_time = [double]'${{ needs.defaults-only.outputs.total-time }}'
          $custom_time = [double]'${{ needs.custom-channel.outputs.total-time }}'
          
          if ($defaults_time -lt $full_time) {
            $speedup = [math]::Round($full_time / $defaults_time, 1)
            echo "- Defaults-only is ${speedup}x faster than full channels" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ('${{ needs.custom-channel.outputs.success }}' -eq 'true' -and $custom_time -lt $full_time) {
            $speedup = [math]::Round($full_time / $custom_time, 1)
            echo "- Custom channel is ${speedup}x faster than full channels" >> $env:GITHUB_STEP_SUMMARY
          }
          
          if ('${{ needs.custom-channel.outputs.success }}' -ne 'true') {
            echo "- Custom channel test failed - insufficient packages available" >> $env:GITHUB_STEP_SUMMARY
          }
